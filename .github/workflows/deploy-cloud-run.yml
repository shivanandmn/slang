name: Test and Deploy to Cloud Run

on:
  push:
    branches: [ "main" ]
    paths:
      - "multi_agent.py"
      - "requirements.txt"
      - "Dockerfile"
      - ".github/workflows/deploy-cloud-run.yml"
  workflow_dispatch:

env:
  SERVICE_NAME: slang-agent
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run CI validation tests
        run: python test_ci.py

  deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (WIF)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    - name: Set up gcloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: ">= 474.0.0"

    - name: Validate required secrets
      run: |
        if [ -z "${{ secrets.LIVEKIT_URL }}" ]; then
          echo "LIVEKIT_URL GitHub secret is required but not set." >&2
          exit 1
        fi

    - name: Configure Docker to use gcloud as a credential helper
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build Docker image
      run: |
        docker build -t us-central1-docker.pkg.dev/$GCP_PROJECT_ID/slang-agent-repo/$SERVICE_NAME:$GITHUB_SHA .
        docker tag us-central1-docker.pkg.dev/$GCP_PROJECT_ID/slang-agent-repo/$SERVICE_NAME:$GITHUB_SHA us-central1-docker.pkg.dev/$GCP_PROJECT_ID/slang-agent-repo/$SERVICE_NAME:latest

    - name: Push Docker image to Artifact Registry
      run: |
        docker push us-central1-docker.pkg.dev/$GCP_PROJECT_ID/slang-agent-repo/$SERVICE_NAME:$GITHUB_SHA
        docker push us-central1-docker.pkg.dev/$GCP_PROJECT_ID/slang-agent-repo/$SERVICE_NAME:latest

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy "$SERVICE_NAME" \
          --image us-central1-docker.pkg.dev/$GCP_PROJECT_ID/slang-agent-repo/$SERVICE_NAME:$GITHUB_SHA \
          --platform managed \
          --project "$GCP_PROJECT_ID" \
          --region "$GCP_REGION" \
          --allow-unauthenticated \
          --memory 2Gi \
          --cpu 1 \
          --concurrency 1000 \
          --timeout 3600s \
          --max-instances 10 \
          --min-instances 0 \
          --service-account "$GCP_SERVICE_ACCOUNT" \
          --set-env-vars LIVEKIT_URL="${{ secrets.LIVEKIT_URL }}" \
          --set-secrets LIVEKIT_API_KEY=LIVEKIT_API_KEY:latest,LIVEKIT_API_SECRET=LIVEKIT_API_SECRET:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest,DEEPGRAM_API_KEY=DEEPGRAM_API_KEY:latest,ELEVEN_API_KEY=ELEVEN_API_KEY:latest

    - name: Get Cloud Run URL
      run: |
        SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" --platform managed --region "$GCP_REGION" --format 'value(status.url)')
        echo "Service deployed at: $SERVICE_URL"
        echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

    - name: Test deployment
      run: |
        echo "Testing deployment health..."
        echo "Service URL: $SERVICE_URL"
        echo "Deployment completed successfully!"
